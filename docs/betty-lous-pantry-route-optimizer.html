<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betty Lou's Pantry - Letter Carrier Food Drive</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E87C1E 0%, #C4650F 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        .logo {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        header h1 { font-size: 2.2rem; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        header p { font-size: 1.1rem; opacity: 0.95; }
        .card {
            background: white; border-radius: 12px; padding: 25px;
            margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 { color: #333; margin-bottom: 15px; font-size: 1.2rem; }
        .drop-zone {
            border: 3px dashed #ccc; border-radius: 10px; padding: 40px;
            text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f9f9f9;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: #E87C1E; background: #fff8f0; }
        .drop-zone.loaded { border-color: #4CAF50; background: #f0fff0; }
        .drop-zone p { color: #666; margin-bottom: 10px; }
        .drop-zone .icon { font-size: 3rem; margin-bottom: 10px; }
        input[type="file"] { display: none; }
        .stats { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .stat { background: #f5f5f5; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; }
        .stat.success { background: #e8f5e9; color: #2e7d32; }
        .stat.warning { background: #fff3e0; color: #ef6c00; }
        .stat.error { background: #ffebee; color: #c62828; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 500; color: #333; margin-bottom: 5px; }
        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%; max-width: 400px; padding: 10px 15px;
            font-size: 1rem; border: 2px solid #ddd; border-radius: 8px;
        }
        .form-group input:focus { outline: none; border-color: #E87C1E; }
        .form-group small { color: #888; display: block; margin-top: 5px; }
        .inline-group { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .inline-group .form-group { margin-bottom: 0; }
        .btn {
            padding: 12px 25px; font-size: 1rem; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary { background: linear-gradient(135deg, #E87C1E 0%, #C4650F 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(232, 124, 30, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #f5f5f5; color: #333; border: 2px solid #ddd; }
        .btn-secondary:hover { background: #eee; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .driver-list { margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .driver-input-row {
            display: flex; gap: 10px; align-items: center;
            margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;
        }
        .driver-input-row .driver-num { font-weight: 600; color: #E87C1E; min-width: 30px; }
        .driver-input-row input {
            flex: 1; padding: 8px 12px; border: 2px solid #ddd;
            border-radius: 6px; font-size: 0.95rem;
        }
        .driver-input-row input:focus { outline: none; border-color: #E87C1E; }
        #results { display: none; }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .results-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .driver-card { border: 1px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px; overflow: hidden; }
        .driver-header {
            background: #f5f5f5; padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .driver-header:hover { background: #eee; }
        .driver-header h3 { font-size: 1rem; color: #333; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .badge { padding: 3px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: normal; }
        .badge.count { background: #E87C1E; color: white; }
        .badge.miles { background: #2196F3; color: white; }
        .driver-actions { display: flex; gap: 8px; }
        .driver-content {
            display: none; max-height: none; overflow: visible;
            padding: 15px 20px; background: #fafafa;
        }
        .driver-content.open { display: block; }
        .driver-map {
            width: 100%; height: 350px; border-radius: 8px;
            margin-bottom: 15px; background: #e0e0e0;
        }
        .address-list { max-height: 300px; overflow-y: auto; }
        .address-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #eee; gap: 10px;
        }
        .address-item:last-child { border-bottom: none; }
        .address-item .num { color: #E87C1E; font-weight: 600; font-size: 0.9rem; min-width: 35px; }
        .address-item .address { flex: 1; color: #333; }
        .address-item.dropoff { background: #e8f5e9; padding: 8px; margin: 0 -8px; border-radius: 5px; }
        .address-item.dropoff .num { color: #2e7d32; }
        .address-item a {
            color: #E87C1E; text-decoration: none; font-size: 0.85rem;
            padding: 4px 8px; border-radius: 4px; background: #fff8f0;
        }
        .address-item a:hover { background: #ffedd5; }
        .progress { display: none; margin-top: 15px; }
        .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .progress-fill {
            height: 100%; background: linear-gradient(135deg, #E87C1E 0%, #C4650F 100%);
            width: 0%; transition: width 0.3s ease;
        }
        .progress-text { text-align: center; margin-top: 8px; font-size: 0.9rem; color: #666; }
        .copied-toast {
            position: fixed; bottom: 20px; right: 20px; background: #333; color: white;
            padding: 12px 20px; border-radius: 8px; opacity: 0; transform: translateY(20px);
            transition: all 0.3s ease; z-index: 1000;
        }
        .copied-toast.show { opacity: 1; transform: translateY(0); }
        .total-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .total-stat { background: #f5f5f5; padding: 15px 20px; border-radius: 10px; text-align: center; }
        .total-stat .value { font-size: 1.5rem; font-weight: 700; color: #E87C1E; }
        .total-stat .label { font-size: 0.85rem; color: #666; }
        .dropoff-info { background: #e8f5e9; padding: 10px 15px; border-radius: 8px; margin-top: 10px; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üçû</div>
            <h1>Betty Lou's Pantry</h1>
            <p>Letter Carrier Food Drive ‚Äî Route Optimizer</p>
        </header>
        
        <div class="card">
            <h2>Step 1: Google Maps API Key</h2>
            <div class="form-group">
                <label for="apiKey">API Key (required for maps)</label>
                <input type="text" id="apiKey" placeholder="AIzaSy...">
                <small>Get a key from <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>. Enable "Maps JavaScript API".</small>
            </div>
        </div>
        
        <div class="card">
            <h2>Step 2: Drop-off Location (End Point for All Routes)</h2>
            <div class="form-group">
                <label for="dropoffAddress">Drop-off Address</label>
                <input type="text" id="dropoffAddress" value="538 Thomas St, Coopersburg, PA 18036" style="max-width: 100%;">
            </div>
            <div class="inline-group">
                <div class="form-group">
                    <label for="dropoffLat">Latitude</label>
                    <input type="text" id="dropoffLat" value="40.5193" style="width: 150px;">
                </div>
                <div class="form-group">
                    <label for="dropoffLng">Longitude</label>
                    <input type="text" id="dropoffLng" value="-75.3897" style="width: 150px;">
                </div>
            </div>
            <div class="dropoff-info">üìç All routes will END at this drop-off location</div>
        </div>
        
        <div class="card">
            <h2>Step 3: Upload Address List</h2>
            <div class="drop-zone" id="dropZone">
                <div class="icon">üìÑ</div>
                <p><strong>Drag & drop your CSV file here</strong></p>
                <p>or click to browse</p>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="stats" id="fileStats" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h2>Step 4: Configure Drivers</h2>
            <div class="inline-group" style="margin-bottom: 15px;">
                <div class="form-group">
                    <label for="driverCount">Number of drivers</label>
                    <input type="number" id="driverCount" value="20" min="1" max="100" style="width: 100px;">
                </div>
                <button class="btn btn-secondary" id="updateDriversBtn">Update Driver List</button>
            </div>
            <div class="driver-list" id="driverList"></div>
        </div>
        
        <div class="card">
            <h2>Step 5: Generate Routes</h2>
            <button class="btn btn-primary" id="generateBtn" disabled>Generate Routes</button>
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing...</div>
            </div>
        </div>
        
        <div class="card" id="results">
            <div class="results-header">
                <h2>Routes Generated ‚Äî Review Each Driver's Map</h2>
                <div class="results-actions">
                    <button class="btn btn-success" id="downloadAllHtmlBtn">‚¨á Download All HTML Files</button>
                    <button class="btn btn-secondary" id="downloadAllTxtBtn">‚¨á Download All TXT</button>
                </div>
            </div>
            <div class="total-stats" id="totalStats"></div>
            <div id="driverResults"></div>
        </div>
    </div>
    
    <div class="copied-toast" id="toast">Copied to clipboard!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
    (function() {
        // HAVERSINE DISTANCE (miles)
        function haversine(lat1, lon1, lat2, lon2) {
            var R = 3959;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        // K-MEANS CLUSTERING
        function kmeans(data, k, maxIter) {
            maxIter = maxIter || 100;
            var n = data.length;
            if (n === 0 || k <= 0) return { clusters: [], centroids: [] };
            
            // Initialize centroids with k-means++
            var centroids = [];
            centroids.push(data[Math.floor(Math.random() * n)].slice());
            
            while (centroids.length < k) {
                var distances = [];
                for (var i = 0; i < n; i++) {
                    var minD = Infinity;
                    for (var c = 0; c < centroids.length; c++) {
                        var dx = data[i][0] - centroids[c][0];
                        var dy = data[i][1] - centroids[c][1];
                        var d = dx*dx + dy*dy;
                        if (d < minD) minD = d;
                    }
                    distances.push(minD);
                }
                var sum = 0;
                for (var i = 0; i < distances.length; i++) sum += distances[i];
                var r = Math.random() * sum;
                for (var i = 0; i < n; i++) {
                    r -= distances[i];
                    if (r <= 0) { centroids.push(data[i].slice()); break; }
                }
            }
            
            var clusters = [];
            for (var i = 0; i < n; i++) clusters.push(0);
            
            for (var iter = 0; iter < maxIter; iter++) {
                var changed = false;
                for (var i = 0; i < n; i++) {
                    var minDist = Infinity, minCluster = 0;
                    for (var j = 0; j < k; j++) {
                        var dx = data[i][0] - centroids[j][0];
                        var dy = data[i][1] - centroids[j][1];
                        var d = dx*dx + dy*dy;
                        if (d < minDist) { minDist = d; minCluster = j; }
                    }
                    if (clusters[i] !== minCluster) { clusters[i] = minCluster; changed = true; }
                }
                if (!changed) break;
                
                var newCentroids = [];
                var counts = [];
                for (var j = 0; j < k; j++) { newCentroids.push([0, 0]); counts.push(0); }
                for (var i = 0; i < n; i++) {
                    var c = clusters[i];
                    newCentroids[c][0] += data[i][0];
                    newCentroids[c][1] += data[i][1];
                    counts[c]++;
                }
                for (var j = 0; j < k; j++) {
                    if (counts[j] > 0) {
                        centroids[j] = [newCentroids[j][0] / counts[j], newCentroids[j][1] / counts[j]];
                    }
                }
            }
            return { clusters: clusters, centroids: centroids };
        }

        // STATE
        var addresses = [];
        var clusters = [];
        var drivers = [];
        var loadedFileName = '';
        var googleLoaded = false;
        var driverMaps = {};
        var dropoff = { address: '', lat: 0, lng: 0 };
        
        // DOM ELEMENTS
        var dropZone = document.getElementById('dropZone');
        var fileInput = document.getElementById('fileInput');
        var fileStats = document.getElementById('fileStats');
        var driverCountInput = document.getElementById('driverCount');
        var driverListEl = document.getElementById('driverList');
        var updateDriversBtn = document.getElementById('updateDriversBtn');
        var generateBtn = document.getElementById('generateBtn');
        var progress = document.getElementById('progress');
        var progressFill = document.getElementById('progressFill');
        var progressText = document.getElementById('progressText');
        var results = document.getElementById('results');
        var driverResults = document.getElementById('driverResults');
        var totalStats = document.getElementById('totalStats');
        var downloadAllHtmlBtn = document.getElementById('downloadAllHtmlBtn');
        var downloadAllTxtBtn = document.getElementById('downloadAllTxtBtn');
        var toast = document.getElementById('toast');
        var apiKeyInput = document.getElementById('apiKey');
        var dropoffAddressInput = document.getElementById('dropoffAddress');
        var dropoffLatInput = document.getElementById('dropoffLat');
        var dropoffLngInput = document.getElementById('dropoffLng');
        
        // DRIVER LIST MANAGEMENT
        function updateDriverList() {
            var count = parseInt(driverCountInput.value) || 20;
            var existingNames = [];
            for (var i = 0; i < drivers.length; i++) {
                existingNames.push(drivers[i].name);
            }
            drivers = [];
            for (var i = 0; i < count; i++) {
                drivers.push({ id: i, name: existingNames[i] || 'Driver ' + (i + 1) });
            }
            renderDriverInputs();
        }
        
        function renderDriverInputs() {
            var html = '';
            for (var i = 0; i < drivers.length; i++) {
                html += '<div class="driver-input-row">';
                html += '<span class="driver-num">' + (i + 1) + '.</span>';
                html += '<input type="text" value="' + escapeHtml(drivers[i].name) + '" data-index="' + i + '" placeholder="Driver name">';
                html += '</div>';
            }
            driverListEl.innerHTML = html;
            
            var inputs = driverListEl.querySelectorAll('input');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('change', function() {
                    var idx = parseInt(this.getAttribute('data-index'));
                    drivers[idx].name = this.value || 'Driver ' + (idx + 1);
                });
            }
        }
        
        updateDriversBtn.addEventListener('click', updateDriverList);
        updateDriverList();
        
        // FILE UPLOAD
        dropZone.addEventListener('click', function() { fileInput.click(); });
        dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', function(e) {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });
        
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) { alert('Please upload a CSV file'); return; }
            loadedFileName = file.name;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(result) { processCSV(result.data); },
                error: function(error) { alert('Error parsing CSV: ' + error.message); }
            });
        }
        
        function processCSV(data) {
            addresses = [];
            var poBoxCount = 0, missingCoordsCount = 0;
            
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var slug = (row.Slug || '').toUpperCase();
                var addr = (row.Address || '').toUpperCase();
                if (slug === 'BOXHOLDER' || addr.indexOf('PO BOX') >= 0) { poBoxCount++; continue; }
                
                var lat = parseFloat(row.LATITUDE || row.Latitude || row.lat);
                var lng = parseFloat(row.LONGITUDE || row.Longitude || row.lng || row.lon);
                if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) { missingCoordsCount++; continue; }
                
                var parts = [];
                if (row.Address) parts.push(row.Address);
                if (row.City) parts.push(row.City);
                if (row.State) parts.push(row.State);
                if (row.Zip) parts.push(row.Zip);
                
                addresses.push({
                    address: row.Address || '',
                    fullAddress: parts.join(', '),
                    lat: lat,
                    lng: lng
                });
            }
            
            dropZone.classList.add('loaded');
            dropZone.innerHTML = '<div class="icon">‚úÖ</div><p><strong>' + escapeHtml(loadedFileName) + ' loaded</strong></p><p>Click to upload a different file</p>';
            
            fileStats.style.display = 'flex';
            var statsHtml = '<div class="stat success">‚úì ' + addresses.length.toLocaleString() + ' street addresses</div>';
            if (poBoxCount > 0) statsHtml += '<div class="stat warning">‚ö† ' + poBoxCount + ' PO Boxes filtered</div>';
            if (missingCoordsCount > 0) statsHtml += '<div class="stat error">‚úó ' + missingCoordsCount + ' missing coordinates</div>';
            fileStats.innerHTML = statsHtml;
            
            generateBtn.disabled = addresses.length === 0;
        }
        
        // GOOGLE MAPS LOADING
        function loadGoogleMaps(callback) {
            var apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('Please enter a Google Maps API key');
                return false;
            }
            
            if (googleLoaded && window.google && window.google.maps) {
                callback();
                return true;
            }
            
            window.initGoogleMaps = function() {
                googleLoaded = true;
                callback();
            };
            
            var script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&callback=initGoogleMaps';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                alert('Failed to load Google Maps. Check your API key.');
                generateBtn.disabled = false;
            };
            document.head.appendChild(script);
            return true;
        }
        
        // GENERATE ROUTES
        generateBtn.addEventListener('click', function() {
            if (addresses.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }
            
            // Get dropoff info
            dropoff.address = dropoffAddressInput.value.trim();
            dropoff.lat = parseFloat(dropoffLatInput.value);
            dropoff.lng = parseFloat(dropoffLngInput.value);
            
            if (!dropoff.address || isNaN(dropoff.lat) || isNaN(dropoff.lng)) {
                alert('Please enter valid drop-off location coordinates');
                return;
            }
            
            generateBtn.disabled = true;
            
            if (!loadGoogleMaps(runGeneration)) {
                generateBtn.disabled = false;
            }
        });
        
        function runGeneration() {
            progress.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Clustering addresses...';
            driverMaps = {};
            
            setTimeout(function() {
                var numDrivers = drivers.length;
                var points = [];
                for (var i = 0; i < addresses.length; i++) {
                    points.push([addresses[i].lat, addresses[i].lng]);
                }
                
                progressFill.style.width = '30%';
                var result = kmeans(points, numDrivers, 100);
                
                progressFill.style.width = '50%';
                progressText.textContent = 'Ordering routes...';
                
                setTimeout(function() {
                    // Assign addresses to clusters
                    clusters = [];
                    for (var i = 0; i < numDrivers; i++) clusters.push([]);
                    for (var i = 0; i < result.clusters.length; i++) {
                        clusters[result.clusters[i]].push(addresses[i]);
                    }
                    
                    // Order each cluster to end at dropoff
                    for (var i = 0; i < clusters.length; i++) {
                        clusters[i] = orderClusterToDropoff(clusters[i]);
                    }
                    
                    progressFill.style.width = '90%';
                    progressText.textContent = 'Calculating distances...';
                    
                    setTimeout(function() {
                        // Calculate mileage for each cluster
                        for (var i = 0; i < clusters.length; i++) {
                            calculateClusterMileage(clusters[i]);
                        }
                        
                        renderResults();
                        
                        progressFill.style.width = '100%';
                        progressText.textContent = 'Complete!';
                        
                        setTimeout(function() {
                            progress.style.display = 'none';
                            generateBtn.disabled = false;
                            // Init first driver map - wait for DOM to fully stabilize
                            setTimeout(function() {
                                var firstCard = document.querySelector('.driver-card .driver-content.open');
                                if (firstCard) {
                                    initSingleDriverMap(0);
                                }
                            }, 500);
                        }, 300);
                    }, 50);
                }, 50);
            }, 50);
        }
        
        function orderClusterToDropoff(cluster) {
            if (cluster.length === 0) return cluster;
            if (cluster.length === 1) return cluster;
            
            // Group by coordinate (many addresses share same lat/lng in ZIP+4 data)
            var groups = {};
            for (var i = 0; i < cluster.length; i++) {
                var addr = cluster[i];
                var key = addr.lat.toFixed(6) + ',' + addr.lng.toFixed(6);
                if (!groups[key]) {
                    groups[key] = { lat: addr.lat, lng: addr.lng, addresses: [] };
                }
                groups[key].addresses.push(addr);
            }
            
            // Sort addresses within each group by street name/number
            var groupKeys = Object.keys(groups);
            for (var k = 0; k < groupKeys.length; k++) {
                var g = groups[groupKeys[k]];
                g.addresses.sort(function(a, b) {
                    var streetA = a.address.replace(/^\d+\s*/, '');
                    var streetB = b.address.replace(/^\d+\s*/, '');
                    if (streetA !== streetB) return streetA.localeCompare(streetB);
                    return (parseInt(a.address) || 0) - (parseInt(b.address) || 0);
                });
            }
            
            var groupList = [];
            for (var k = 0; k < groupKeys.length; k++) {
                groupList.push(groups[groupKeys[k]]);
            }
            
            // Find the group furthest from dropoff - start there
            var maxDist = -1;
            var startIdx = 0;
            for (var i = 0; i < groupList.length; i++) {
                var d = haversine(groupList[i].lat, groupList[i].lng, dropoff.lat, dropoff.lng);
                if (d > maxDist) {
                    maxDist = d;
                    startIdx = i;
                }
            }
            
            // Nearest neighbor ordering starting from furthest point
            var ordered = [];
            var visited = {};
            var current = groupList[startIdx];
            
            while (Object.keys(visited).length < groupList.length) {
                var key = current.lat + ',' + current.lng;
                if (!visited[key]) {
                    visited[key] = true;
                    for (var i = 0; i < current.addresses.length; i++) {
                        ordered.push(current.addresses[i]);
                    }
                    
                    // Find nearest unvisited (prioritizing those closer to remaining path to dropoff)
                    var nearest = null;
                    var nearestScore = Infinity;
                    
                    for (var j = 0; j < groupList.length; j++) {
                        var g = groupList[j];
                        var gKey = g.lat + ',' + g.lng;
                        if (!visited[gKey]) {
                            // Score = distance from current + distance to dropoff (encourages moving toward dropoff)
                            var distFromCurrent = haversine(current.lat, current.lng, g.lat, g.lng);
                            var score = distFromCurrent;
                            if (score < nearestScore) {
                                nearestScore = score;
                                nearest = g;
                            }
                        }
                    }
                    if (nearest) current = nearest;
                }
            }
            
            return ordered;
        }
        
        function calculateClusterMileage(cluster) {
            var totalMiles = 0;
            for (var i = 0; i < cluster.length; i++) {
                if (i === 0) {
                    cluster[i].mileage = 0;
                } else {
                    var prev = cluster[i - 1];
                    var curr = cluster[i];
                    var dist = haversine(prev.lat, prev.lng, curr.lat, curr.lng);
                    cluster[i].mileage = dist;
                    totalMiles += dist;
                }
            }
            // Add distance from last stop to dropoff
            if (cluster.length > 0) {
                var last = cluster[cluster.length - 1];
                var toDropoff = haversine(last.lat, last.lng, dropoff.lat, dropoff.lng);
                cluster.totalMiles = totalMiles + toDropoff;
                cluster.milesToDropoff = toDropoff;
            } else {
                cluster.totalMiles = 0;
                cluster.milesToDropoff = 0;
            }
        }
        
        // RENDER RESULTS
        function renderResults() {
            results.style.display = 'block';
            driverResults.innerHTML = '';

            var totalAddresses = 0;
            var totalMiles = 0;

            // Calculate totals first
            for (var i = 0; i < clusters.length; i++) {
                totalAddresses += clusters[i].length;
                totalMiles += clusters[i].totalMiles || 0;
            }

            // Display summary stats immediately
            var avgMiles = drivers.length > 0 ? (totalMiles / drivers.length).toFixed(1) : '0';
            totalStats.innerHTML = '';
            totalStats.innerHTML += '<div class="total-stat"><div class="value">' + totalAddresses.toLocaleString() + '</div><div class="label">Total Addresses</div></div>';
            totalStats.innerHTML += '<div class="total-stat"><div class="value">' + drivers.length + '</div><div class="label">Drivers</div></div>';
            totalStats.innerHTML += '<div class="total-stat"><div class="value">' + totalMiles.toFixed(1) + '</div><div class="label">Total Miles</div></div>';
            totalStats.innerHTML += '<div class="total-stat"><div class="value">' + avgMiles + '</div><div class="label">Avg Miles/Driver</div></div>';

            // Batch render driver cards to prevent DOM thrashing
            var batchSize = 3;
            var currentIndex = 0;

            function renderBatch() {
                var endIndex = Math.min(currentIndex + batchSize, clusters.length);
                var fragment = document.createDocumentFragment();

                for (var i = currentIndex; i < endIndex; i++) {
                    var cluster = clusters[i];
                    var driver = drivers[i];

                    var card = document.createElement('div');
                    card.className = 'driver-card';

                    var milesStr = (cluster.totalMiles || 0).toFixed(1);

                    var headerHtml = '<div class="driver-header" data-index="' + i + '">';
                    headerHtml += '<h3>' + escapeHtml(driver.name);
                    headerHtml += ' <span class="badge count">' + cluster.length + ' stops</span>';
                    headerHtml += ' <span class="badge miles">' + milesStr + ' mi</span>';
                    headerHtml += '</h3>';
                    headerHtml += '<div class="driver-actions">';
                    headerHtml += '<button class="btn btn-secondary btn-small" data-action="html" data-index="' + i + '">üìÑ HTML</button>';
                    headerHtml += '<button class="btn btn-secondary btn-small" data-action="copy" data-index="' + i + '">üìã Copy</button>';
                    headerHtml += '</div></div>';

                    // Defer address list rendering - only render first 20 initially, rest on demand
                    var contentHtml = '<div class="driver-content" id="driver-content-' + i + '">';
                    contentHtml += '<div class="driver-map" id="driver-map-' + i + '"></div>';
                    contentHtml += '<div class="address-list" id="address-list-' + i + '">';

                    var maxInitialRender = 20;
                    var renderCount = Math.min(cluster.length, maxInitialRender);

                    for (var j = 0; j < renderCount; j++) {
                        var addr = cluster[j];
                        contentHtml += '<div class="address-item">';
                        contentHtml += '<span class="num">' + (j + 1) + '.</span>';
                        contentHtml += '<span class="address">' + escapeHtml(addr.fullAddress) + '</span>';
                        contentHtml += '<a href="' + getMapsLink(addr) + '" target="_blank">Maps ‚Üó</a>';
                        contentHtml += '</div>';
                    }

                    // Add "load more" placeholder if there are more addresses
                    if (cluster.length > maxInitialRender) {
                        contentHtml += '<div class="address-item load-more" data-driver="' + i + '" style="cursor:pointer;background:#fff8f0;justify-content:center;">';
                        contentHtml += '<span style="color:#E87C1E;font-weight:600;">‚ñº Show ' + (cluster.length - maxInitialRender) + ' more addresses</span>';
                        contentHtml += '</div>';
                    }

                    // Add dropoff as final stop
                    contentHtml += '<div class="address-item dropoff">';
                    contentHtml += '<span class="num">END</span>';
                    contentHtml += '<span class="address">üèÅ ' + escapeHtml(dropoff.address) + ' (Drop-off)</span>';
                    contentHtml += '<a href="' + getMapsLink(dropoff) + '" target="_blank">Maps ‚Üó</a>';
                    contentHtml += '</div>';

                    contentHtml += '</div></div>';

                    card.innerHTML = headerHtml + contentHtml;
                    fragment.appendChild(card);
                }

                driverResults.appendChild(fragment);
                currentIndex = endIndex;

                if (currentIndex < clusters.length) {
                    // Render next batch after a short delay
                    setTimeout(renderBatch, 30);
                } else {
                    // All cards rendered - set up event listeners
                    setupEventListeners();
                    // Open first driver
                    var firstContent = document.getElementById('driver-content-0');
                    if (firstContent) firstContent.classList.add('open');
                }
            }

            function setupEventListeners() {
                // Header click handlers
                var headers = driverResults.querySelectorAll('.driver-header');
                for (var h = 0; h < headers.length; h++) {
                    headers[h].addEventListener('click', function(e) {
                        if (e.target.tagName === 'BUTTON') return;
                        var idx = parseInt(this.getAttribute('data-index'));
                        var content = document.getElementById('driver-content-' + idx);
                        var wasOpen = content.classList.contains('open');
                        content.classList.toggle('open');
                        if (!wasOpen && !driverMaps[idx]) {
                            // Delay map init to let DOM update
                            setTimeout(function() { initSingleDriverMap(idx); }, 150);
                        } else if (wasOpen && driverMaps[idx]) {
                            // Cleanup map when closing card to free memory
                            driverMaps[idx] = null;
                        }
                    });
                }

                // Button handlers
                var buttons = driverResults.querySelectorAll('button[data-action]');
                for (var b = 0; b < buttons.length; b++) {
                    buttons[b].addEventListener('click', function(e) {
                        e.stopPropagation();
                        var action = this.getAttribute('data-action');
                        var idx = parseInt(this.getAttribute('data-index'));
                        if (action === 'html') downloadDriverHtml(idx);
                        if (action === 'copy') copyDriver(idx);
                    });
                }

                // Load more handlers
                var loadMoreBtns = driverResults.querySelectorAll('.load-more');
                for (var l = 0; l < loadMoreBtns.length; l++) {
                    loadMoreBtns[l].addEventListener('click', function(e) {
                        e.stopPropagation();
                        var driverIdx = parseInt(this.getAttribute('data-driver'));
                        loadRemainingAddresses(driverIdx, this);
                    });
                }
            }

            // Start batched rendering
            renderBatch();
        }

        function loadRemainingAddresses(driverIndex, loadMoreEl) {
            var cluster = clusters[driverIndex];
            var addressList = document.getElementById('address-list-' + driverIndex);
            if (!addressList || !cluster) return;

            // Build remaining addresses HTML
            var fragment = document.createDocumentFragment();
            for (var j = 20; j < cluster.length; j++) {
                var addr = cluster[j];
                var item = document.createElement('div');
                item.className = 'address-item';
                item.innerHTML = '<span class="num">' + (j + 1) + '.</span>' +
                    '<span class="address">' + escapeHtml(addr.fullAddress) + '</span>' +
                    '<a href="' + getMapsLink(addr) + '" target="_blank">Maps ‚Üó</a>';
                fragment.appendChild(item);
            }

            // Insert before dropoff (which is at the end)
            var dropoffEl = addressList.querySelector('.address-item.dropoff');
            if (dropoffEl) {
                addressList.insertBefore(fragment, dropoffEl);
            }

            // Remove load more button
            loadMoreEl.remove();
        }
        
        function initSingleDriverMap(driverIndex) {
            if (!window.google || !window.google.maps) return;
            if (driverMaps[driverIndex]) return;

            var mapEl = document.getElementById('driver-map-' + driverIndex);
            // Check element exists AND is visible (has layout)
            if (!mapEl || !mapEl.offsetParent) return;
            
            var cluster = clusters[driverIndex];
            if (!cluster || cluster.length === 0) {
                mapEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">No addresses</div>';
                return;
            }
            
            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < cluster.length; i++) {
                bounds.extend({ lat: cluster[i].lat, lng: cluster[i].lng });
            }
            bounds.extend({ lat: dropoff.lat, lng: dropoff.lng });
            
            var map = new google.maps.Map(mapEl, {
                center: bounds.getCenter(),
                zoom: 12
            });
            map.fitBounds(bounds);
            
            // Add numbered markers for addresses
            for (var i = 0; i < cluster.length; i++) {
                var addr = cluster[i];
                new google.maps.Marker({
                    position: { lat: addr.lat, lng: addr.lng },
                    map: map,
                    label: { text: String(i + 1), color: 'white', fontSize: '11px', fontWeight: 'bold' },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#E87C1E',
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: 'white',
                        scale: 14
                    },
                    title: (i + 1) + '. ' + addr.fullAddress
                });
            }
            
            // Add dropoff marker (green)
            new google.maps.Marker({
                position: { lat: dropoff.lat, lng: dropoff.lng },
                map: map,
                label: { text: 'üèÅ', fontSize: '16px' },
                title: 'DROP-OFF: ' + dropoff.address
            });
            
            // Draw route line
            var path = [];
            for (var i = 0; i < cluster.length; i++) {
                path.push({ lat: cluster[i].lat, lng: cluster[i].lng });
            }
            path.push({ lat: dropoff.lat, lng: dropoff.lng });
            
            new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#E87C1E',
                strokeOpacity: 0.7,
                strokeWeight: 3,
                map: map
            });
            
            driverMaps[driverIndex] = map;
        }
        
        function getMapsLink(addr) {
            return 'https://www.google.com/maps/search/?api=1&query=' + addr.lat + ',' + addr.lng;
        }
        
        // DOWNLOADS
        function getDriverText(index) {
            var cluster = clusters[index];
            var driver = drivers[index];
            var miles = (cluster.totalMiles || 0).toFixed(1);
            
            var text = driver.name + ' ‚Äî ' + cluster.length + ' stops ‚Äî ' + miles + ' miles\n';
            text += '==================================================\n\n';
            
            for (var j = 0; j < cluster.length; j++) {
                var addr = cluster[j];
                text += (j + 1) + '. ' + addr.fullAddress + '\n';
                text += '   ' + getMapsLink(addr) + '\n\n';
            }
            
            text += 'END: ' + dropoff.address + ' (Drop-off)\n';
            text += '   ' + getMapsLink(dropoff) + '\n';
            
            return text;
        }
        
        function generateDriverHtml(index) {
            var cluster = clusters[index];
            var driver = drivers[index];
            var apiKey = apiKeyInput.value.trim();
            var miles = (cluster.totalMiles || 0).toFixed(1);
            
            var addressListHtml = '';
            for (var j = 0; j < cluster.length; j++) {
                var addr = cluster[j];
                addressListHtml += '<div style="display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">';
                addressListHtml += '<span style="min-width:40px;color:#E87C1E;font-weight:600;">' + (j + 1) + '.</span>';
                addressListHtml += '<span style="flex:1;">' + escapeHtml(addr.fullAddress) + '</span>';
                addressListHtml += '<a href="' + getMapsLink(addr) + '" target="_blank" style="margin-left:10px;color:#E87C1E;text-decoration:none;padding:5px 10px;background:#fff8f0;border-radius:5px;">Navigate ‚Üó</a>';
                addressListHtml += '</div>';
            }
            // Dropoff
            addressListHtml += '<div style="display:flex;align-items:center;padding:12px;background:#e8f5e9;border-radius:5px;margin-top:10px;">';
            addressListHtml += '<span style="min-width:40px;color:#2e7d32;font-weight:600;">END</span>';
            addressListHtml += '<span style="flex:1;">üèÅ ' + escapeHtml(dropoff.address) + ' (Drop-off)</span>';
            addressListHtml += '<a href="' + getMapsLink(dropoff) + '" target="_blank" style="margin-left:10px;color:#2e7d32;text-decoration:none;padding:5px 10px;background:#c8e6c9;border-radius:5px;">Navigate ‚Üó</a>';
            addressListHtml += '</div>';
            
            var markersJs = '';
            for (var i = 0; i < cluster.length; i++) {
                var a = cluster[i];
                markersJs += 'new google.maps.Marker({position:{lat:' + a.lat + ',lng:' + a.lng + '},map:map,';
                markersJs += 'label:{text:"' + (i+1) + '",color:"white",fontSize:"11px",fontWeight:"bold"},';
                markersJs += 'icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:"#E87C1E",fillOpacity:1,strokeWeight:2,strokeColor:"white",scale:14}';
                markersJs += '});\n';
            }
            // Dropoff marker
            markersJs += 'new google.maps.Marker({position:{lat:' + dropoff.lat + ',lng:' + dropoff.lng + '},map:map,';
            markersJs += 'label:{text:"üèÅ",fontSize:"16px"},title:"DROP-OFF"});\n';
            
            var pathJs = 'var path=[';
            for (var i = 0; i < cluster.length; i++) {
                if (i > 0) pathJs += ',';
                pathJs += '{lat:' + cluster[i].lat + ',lng:' + cluster[i].lng + '}';
            }
            pathJs += ',{lat:' + dropoff.lat + ',lng:' + dropoff.lng + '}];\n';
            pathJs += 'new google.maps.Polyline({path:path,geodesic:true,strokeColor:"#E87C1E",strokeOpacity:0.7,strokeWeight:3,map:map});\n';
            
            var boundsJs = 'var bounds=new google.maps.LatLngBounds();\n';
            for (var i = 0; i < cluster.length; i++) {
                boundsJs += 'bounds.extend({lat:' + cluster[i].lat + ',lng:' + cluster[i].lng + '});\n';
            }
            boundsJs += 'bounds.extend({lat:' + dropoff.lat + ',lng:' + dropoff.lng + '});\n';
            boundsJs += 'map.fitBounds(bounds);\n';
            
            var html = '<!DOCTYPE html><html lang="en"><head>';
            html += '<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">';
            html += '<title>' + escapeHtml(driver.name) + ' - Betty Lou\'s Pantry Route</title>';
            html += '<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f5f5}';
            html += '.header{background:linear-gradient(135deg,#E87C1E 0%,#C4650F 100%);color:white;padding:20px;text-align:center}';
            html += '.header h1{font-size:1.8rem;margin-bottom:5px}.header p{opacity:0.9}';
            html += '.stats{display:flex;justify-content:center;gap:30px;padding:15px;background:rgba(0,0,0,0.1);margin-top:15px;border-radius:10px}';
            html += '.stat{text-align:center}.stat-value{font-size:1.5rem;font-weight:700}.stat-label{font-size:0.85rem;opacity:0.9}';
            html += '#map{width:100%;height:450px}.container{max-width:800px;margin:0 auto;padding:20px}';
            html += '.card{background:white;border-radius:12px;padding:20px;margin-top:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.card h2{margin-bottom:15px;color:#333}</style></head><body>';
            html += '<div class="header"><h1>üçû ' + escapeHtml(driver.name) + '</h1>';
            html += '<p>Betty Lou\'s Pantry ‚Äî Letter Carrier Food Drive</p>';
            html += '<div class="stats"><div class="stat"><div class="stat-value">' + cluster.length + '</div><div class="stat-label">Stops</div></div>';
            html += '<div class="stat"><div class="stat-value">' + miles + '</div><div class="stat-label">Miles</div></div></div></div>';
            html += '<div id="map"></div>';
            html += '<div class="container"><div class="card"><h2>Route Addresses</h2>' + addressListHtml + '</div></div>';
            
            if (apiKey) {
                html += '<script src="https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&callback=initMap" async defer><\/script>';
                html += '<script>function initMap(){var map=new google.maps.Map(document.getElementById("map"),{center:{lat:' + (cluster[0]?.lat || dropoff.lat) + ',lng:' + (cluster[0]?.lng || dropoff.lng) + '},zoom:13});';
                html += markersJs + pathJs + boundsJs + '}<\/script>';
            }
            
            html += '</body></html>';
            return html;
        }
        
        function downloadDriverHtml(index) {
            var html = generateDriverHtml(index);
            var driver = drivers[index];
            downloadFile(html, slugify(driver.name) + '-route.html', 'text/html');
        }
        
        function copyDriver(index) {
            navigator.clipboard.writeText(getDriverText(index)).then(function() { showToast('Copied to clipboard!'); });
        }
        
        downloadAllHtmlBtn.addEventListener('click', function() {
            var zip = new JSZip();
            for (var i = 0; i < clusters.length; i++) {
                zip.file(slugify(drivers[i].name) + '-route.html', generateDriverHtml(i));
            }
            
            var totalMiles = 0;
            for (var i = 0; i < clusters.length; i++) totalMiles += clusters[i].totalMiles || 0;
            
            var summary = 'Betty Lou\'s Pantry - Letter Carrier Food Drive\nRoute Summary\n==================================================\n\n';
            summary += 'Generated: ' + new Date().toLocaleString() + '\n';
            summary += 'Drop-off: ' + dropoff.address + '\n';
            summary += 'Total Addresses: ' + addresses.length + '\n';
            summary += 'Total Miles: ' + totalMiles.toFixed(1) + '\n';
            summary += 'Drivers: ' + drivers.length + '\n\n';
            for (var i = 0; i < drivers.length; i++) {
                var miles = (clusters[i].totalMiles || 0).toFixed(1);
                summary += drivers[i].name + ': ' + clusters[i].length + ' stops, ' + miles + ' mi\n';
            }
            zip.file('summary.txt', summary);
            
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                downloadFile(content, 'betty-lous-pantry-routes-' + new Date().toISOString().slice(0, 10) + '.zip', 'application/zip');
            });
        });
        
        downloadAllTxtBtn.addEventListener('click', function() {
            var zip = new JSZip();
            for (var i = 0; i < clusters.length; i++) {
                zip.file(slugify(drivers[i].name) + '.txt', getDriverText(i));
            }
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                downloadFile(content, 'betty-lous-routes-txt-' + new Date().toISOString().slice(0, 10) + '.zip', 'application/zip');
            });
        });
        
        // HELPERS
        function downloadFile(content, filename, type) {
            var blob = content instanceof Blob ? content : new Blob([content], { type: type });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function slugify(str) {
            return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'driver';
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }
        
        // LOAD SAVED API KEY
        var savedKey = localStorage.getItem('gmapsApiKey');
        if (savedKey) apiKeyInput.value = savedKey;
        apiKeyInput.addEventListener('change', function() {
            localStorage.setItem('gmapsApiKey', apiKeyInput.value);
        });
    })();
    </script>
</body>
</html>
